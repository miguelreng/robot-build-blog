---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { builders as buildersData } from '../data/builders';

const posts = await getCollection('posts');
posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const builders = buildersData.map(builder => {
	const avatarUrl = builder.github 
		? `https://github.com/${builder.github}.png`
		: `/images/placeholder.jpeg`;
	return {
		...builder,
		image: avatarUrl
	};
});
---

<Layout title="Home">
	<div class="space-y-12">
		{/* CEO Note - SUPER COMPACT */}
		<section class="mb-4">
			<div class="text-brand-gray-90/60 text-[18px] leading-relaxed mb-6 font-semibold max-w-lg text-balance">
				"Building general-purpose robots requires more than just code; it requires a commitment to raw, fast, and transparent iteration. This blog is our window into that process."
			</div>
			<div class="flex items-center gap-8">
                <div class="flex flex-col">
                    <div class="text-[15px] font-semibold text-brand-gray-90">Felipe Chávez</div>
                    <div class="text-[13px] text-brand-gray-90/40 font-medium">CEO at Robot.com</div>
                </div>
                <div class="flex items-center">
                    <img src="/signature.svg" alt="Felipe Chávez Signature" class="h-16 w-auto dark:invert opacity-80 select-none grayscale" />
                </div>
			</div>
		</section>

		<div class="space-y-10 pt-10">
			{/* Memos Section */}
			{/* Memos Section */}
			<section>
				<h2 class="text-sm text-brand-gray-90/30 mb-2 font-semibold border-b border-brand-gray-90/3 pb-2">Memos</h2>
				<ul class="space-y-3">
					{posts.map((post) => (
						<li class="w-full">
							<a 
                                href={`/posts/${post.slug}`} 
                                class="flex items-baseline justify-between w-full group preview-trigger"
                                data-preview={post.data.coverImage}
                            >
								<span class="text-[16px] font-semibold text-brand-gray-90 group-hover:underline decoration-1 underline-offset-4">{post.data.title}</span>
								<div class="flex-grow mx-4 border-b border-brand-gray-50/15"></div>
								<span class="text-[14px] text-brand-gray-90/60 font-medium whitespace-nowrap">{post.data.pubDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' })}</span>
							</a>
						</li>
					))}
				</ul>
			</section>

			{/* Builders Section */}
			<section>
				<h2 class="text-sm text-brand-gray-90/30 mb-2 font-semibold border-b border-brand-gray-90/3 pb-2">Builders</h2>
				<ul class="space-y-3">
					{builders.map((builder) => (
						<li class="w-full">
							<a 
                                href="/builders" 
                                class="flex items-baseline justify-between w-full group preview-trigger"
                                data-preview={builder.image}
                            >
								<span class="text-[16px] font-semibold text-brand-gray-90 group-hover:underline decoration-1 underline-offset-4">{builder.name}</span>
								<div class="flex-grow mx-4 border-b border-brand-gray-50/15"></div>
								<span class="text-[14px] text-brand-gray-90/60 font-medium whitespace-nowrap">{builder.department}</span>
							</a>
						</li>
					))}
				</ul>
			</section>

		</div>
	</div>

    <div id="hover-preview" class="fixed pointer-events-none z-[100] opacity-0 transition-opacity duration-300">
		<div class="w-[280px] h-[160px] overflow-hidden rounded-[16px] border border-brand-gray-90/10 shadow-2xl bg-white">
			<img id="preview-img" src="" class="w-full h-full object-cover transition-all scale-105" onerror="this.src='/images/placeholder.jpeg'" />
		</div>
	</div>

    <script>
		const preview = document.getElementById('hover-preview');
		const previewImg = document.getElementById('preview-img') as HTMLImageElement;
		const triggers = document.querySelectorAll('.preview-trigger');

		triggers.forEach(el => {
			el.addEventListener('mouseenter', (e: any) => {
				const imgUrl = e.currentTarget.dataset.preview;
				if (imgUrl && preview && previewImg) {
					previewImg.src = imgUrl;
					preview.style.opacity = '1';
				}
			});
			el.addEventListener('mouseleave', () => { if (preview) preview.style.opacity = '0'; });
			el.addEventListener('mousemove', (e: any) => {
				if (preview) {
					preview.style.left = `${e.clientX + 20}px`;
					preview.style.top = `${e.clientY + 20}px`;
				}
			});
		});
	</script>
</Layout>
