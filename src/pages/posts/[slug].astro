---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import { builders as buildersData } from '../../data/builders';
import { getGravatarUrl } from '../../utils/gravatar';
import { TeamTooltip } from '../../components/TeamTooltip';

// Dynamic route handler - no getStaticPaths needed with prerender = false
const { slug } = Astro.params;
const posts = await getCollection('posts');
const entry = posts.find(p => p.slug === slug);

if (!entry) {
  return Astro.redirect('/404');
}

const { Content } = await render(entry);
const { title, pubDate, author, quarter = "2026-Q1", builderImage, department } = entry.data;

const publishedLabel = pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

const builderData = buildersData.find(b => b.name === author);

// Priority: builderImage (from frontmatter) -> GitHub (from data) -> Fallback GitHub from name
const avatarSource = builderImage || 
                    (builderData?.github ? `https://github.com/${builderData.github}.png` : null) || 
                    `https://github.com/${author.replace(' ', '').toLowerCase()}.png`;

// Related Posts Logic
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(p => p.slug !== entry.slug) // Exclude current
  .filter(p => p.data.department === department || p.data.author === author) // Same Team or Author
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3); // Limit to 3

const teamName = department || 'Engineering';
const teamBuilders = buildersData.filter(b => b.department === teamName);
---

<Layout title={title} builder={author} published={publishedLabel} quarter={quarter} department={department}>
  
  <div class="space-y-4 mb-4">
    <div class="flex justify-between items-start gap-4">
      <h1 class="text-[40px] md:text-[54px] font-bold leading-[1.1] text-brand-gray-90 flex-1">
        {title}
      </h1>
      <a id="edit-post-btn" href={`/publish?edit=${entry.slug}`} class="hidden text-brand-gray-90/60 hover:text-brand-gray-90 transition-colors font-medium text-sm items-center shrink-0 mt-[10px]">
        Edit Article
      </a>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 border-y border-brand-gray-90/5 py-4 w-full">
        <div class="flex flex-col gap-1">
            <div class="text-[12px] text-brand-gray-90/40 font-semibold font-yellix">Published</div>
            <div class="text-[14px] font-medium text-brand-gray-90">{publishedLabel}</div>
        </div>
        <div class="flex flex-col gap-1">
            <div class="text-[12px] text-brand-gray-90/40 font-semibold font-yellix">Builder</div>
            <div class="text-[14px] font-medium text-brand-gray-90">{author}</div>
        </div>
        <div class="flex flex-col gap-1">
            <div class="text-[12px] text-brand-gray-90/40 font-semibold font-yellix">Team</div>
            <TeamTooltip teamName={teamName} builders={teamBuilders} client:load />
        </div>
        <div class="flex flex-col gap-1">
            <div class="text-[12px] text-brand-gray-90/40 font-semibold font-yellix">Quarter</div>
            <div class="text-[14px] font-medium text-brand-gray-90">{quarter}</div>
        </div>
    </div>

    {entry.data.coverImage && (
      <div class="w-full md:w-[60vw] md:relative md:left-1/2 md:-translate-x-1/2 aspect-video rounded-[32px] overflow-hidden border border-brand-gray-90/5 relative group mb-8 mt-4">
        <img src={entry.data.coverImage} alt={title} class="w-full h-full object-cover" />
      </div>
    )}
  </div>

  <div class="prose prose-zinc prose-lg max-w-none 
    prose-headings:font-bold
    prose-p:text-brand-gray-90/80 prose-p:leading-[1.6] prose-p:font-semibold prose-p:text-[17px] prose-p:my-2
    prose-li:text-brand-gray-90/80 prose-li:font-semibold prose-li:text-[17px] prose-li:my-0.5 prose-ul:my-3
    prose-blockquote:border-l prose-blockquote:border-brand-gray-90/10 prose-blockquote:text-brand-gray-90/40
    prose-img:rounded-lg prose-img:shadow-none">
    <Content />
  </div>

  {relatedPosts.length > 0 && (
    <div class="mt-8 pt-8 border-t border-brand-gray-90/5">
      <h3 class="text-sm text-brand-gray-90/30 mb-8 font-semibold">More from {department || "the team"}</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {relatedPosts.map(post => (
           <a href={`/posts/${post.slug}`} class="block group">
              <div class="aspect-video w-full bg-brand-gray-90/5 rounded-xl mb-4 overflow-hidden relative">
                 {post.data.coverImage && <img src={post.data.coverImage} class="w-full h-full object-cover transition-transform duration-500" />}
              </div>
              <h4 class="text-lg font-bold text-brand-gray-90 leading-tight group-hover:underline decoration-1 underline-offset-4">{post.data.title}</h4>
              <p class="text-sm text-brand-gray-90/40 mt-1">{post.data.author}</p>
           </a>
        ))}
      </div>
    </div>
  )}

  <script>
    const isAuthorized = localStorage.getItem('builder_status') === 'authorized';
    if (isAuthorized) {
      document.getElementById('edit-post-btn')?.classList.replace('hidden', 'flex');

    }
  </script>
</Layout>
