---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Memos Console">
	<div class="max-w-[580px] mx-auto min-h-[60vh] flex flex-col justify-center" id="auth-view">
		<h1 class="text-3xl font-medium tracking-tighter mb-4 text-[#403F3C]">Memos Console</h1>
        <p class="text-[12px] text-[#403F3C]/40 mb-16 font-medium tracking-[0.1em]">Engineering Publishing Intelligence.</p>
		
		<div class="space-y-8">
            <div class="relative">
			    <input type="password" id="password" placeholder="Builder Password" class="w-full bg-[#403F3C]/5 border-none rounded-[100px] px-6 py-4 text-[14px] text-[#403F3C] outline-none font-medium focus:ring-1 focus:ring-[#403F3C]/10 transition-all pr-20" />
                <button id="toggle-pass" class="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] uppercase font-bold text-[#403F3C]/20 hover:text-[#403F3C] transition-colors font-yellix">Show</button>
            </div>
            <div class="flex items-center gap-2 px-2">
                <input type="checkbox" id="remember-me" class="w-3 h-3 accent-[#403F3C]" />
                <label for="remember-me" class="text-[11px] font-medium text-[#403F3C]/40">Remember me on this device</label>
            </div>
			<button id="login-btn" class="w-full bg-[#403F3C] text-[#F8F6F3] text-[12px] font-bold uppercase tracking-widest py-4 rounded-[100px] hover:opacity-90 transition-opacity font-yellix">Access Console</button>
		</div>
	</div>

	<div id="console-view" class="hidden pt-12 pb-32 w-full max-w-full">
        <header class="flex justify-between items-center mb-12 w-full px-6">
            <div>
                <h1 class="text-xl font-medium tracking-tighter text-[#403F3C]">Memos Console</h1>
                <p class="text-[10px] text-[#403F3C]/30 font-bold uppercase tracking-widest mt-1">Status: Authorized</p>
            </div>
            <button id="logout-btn" class="text-[10px] uppercase font-bold text-[#403F3C]/20 hover:text-[#403F3C] transition-all font-yellix">Logout</button>
        </header>

        <div class="flex flex-col lg:flex-row gap-12 w-full px-6">
            <!-- Left: Editor Column -->
            <div class="flex-1 min-w-0 space-y-12">
                <section>
                    <h2 class="text-[10px] uppercase tracking-[0.2em] text-[#403F3C]/30 mb-4 font-bold">Source & Configuration</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="relative">
                            <select id="memo-select" class="w-full bg-[#403F3C]/5 border-none rounded-[100px] px-6 py-4 text-[13px] text-[#403F3C] outline-none font-medium cursor-pointer font-yellix appearance-none">
                                <option value="">Select Builders Memo...</option>
                            </select>
                        </div>
                        <input type="password" id="api-key" placeholder="OpenRouter API Key" class="bg-[#403F3C]/5 border-none rounded-[100px] px-6 py-4 text-[13px] text-[#403F3C] outline-none font-mono" />
                    </div>
                </section>

                <section>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-[10px] uppercase tracking-[0.2em] text-[#403F3C]/30 font-bold">Draft Content (MDX)</h2>
                        <button id="ai-btn" class="bg-white border border-[#403F3C]/10 text-[#403F3C] text-[10px] font-bold uppercase px-6 py-2 rounded-[100px] hover:bg-zinc-50 transition-colors font-yellix">Fine-tune with AI</button>
                    </div>
                    <textarea id="editor" class="w-full h-[700px] bg-[#403F3C]/5 border-none rounded-[24px] p-10 text-[14px] text-[#403F3C]/80 font-medium leading-relaxed outline-none focus:bg-[#403F3C]/8 transition-all resize-none font-mono shadow-inner border border-transparent focus:border-[#403F3C]/5" placeholder="Select a memo to begin..."></textarea>
                    <button id="publish-btn" class="w-full mt-6 bg-[#403F3C] text-[#F8F6F3] text-[12px] font-bold uppercase tracking-widest py-5 rounded-[100px] hover:opacity-90 transition-opacity font-yellix">Ship to Production</button>
                </section>
            </div>

            <!-- Right: Toolbox Column -->
            <div class="lg:w-[350px] flex-shrink-0 space-y-12">
                <section>
                    <h2 class="text-[10px] uppercase tracking-[0.2em] text-[#403F3C]/30 mb-6 font-bold">Interactive Components</h2>
                    <div class="space-y-4" id="toolbox">
                        <div draggable="true" class="component-card group p-6 border border-[#403F3C]/5 rounded-[24px] bg-white hover:border-[#403F3C]/20 cursor-grab active:cursor-grabbing transition-all shadow-sm hover:shadow-md" data-type="slider">
                            <div class="text-[11px] font-bold text-[#403F3C]/60 mb-1 group-hover:text-[#403F3C]">Before/After Slider</div>
                            <div class="text-[10px] text-[#403F3C]/30 leading-normal">Drag to compare visual results (e.g. Sim vs Real).</div>
                        </div>
                        <div draggable="true" class="component-card group p-6 border border-[#403F3C]/5 rounded-[24px] bg-white hover:border-[#403F3C]/20 cursor-grab active:cursor-grabbing transition-all shadow-sm hover:shadow-md" data-type="video">
                            <div class="text-[11px] font-bold text-[#403F3C]/60 mb-1 group-hover:text-[#403F3C]">Autonomous Video</div>
                            <div class="text-[10px] text-[#403F3C]/30 leading-normal">Auto-playing loop for robot demos.</div>
                        </div>
                        <div draggable="true" class="component-card group p-6 border border-[#403F3C]/5 rounded-[24px] bg-white hover:border-[#403F3C]/20 cursor-grab active:cursor-grabbing transition-all shadow-sm hover:shadow-md" data-type="chart">
                            <div class="text-[11px] font-bold text-[#403F3C]/60 mb-1 group-hover:text-[#403F3C]">Telemetry Chart</div>
                            <div class="text-[10px] text-[#403F3C]/30 leading-normal">Interactive data visualization (Line/Bar/Pie).</div>
                        </div>
                    </div>
                </section>

                <section class="bg-[#403F3C]/[0.02] p-8 rounded-[32px] border border-[#403F3C]/5">
                    <h2 class="text-[10px] uppercase tracking-[0.2em] text-[#403F3C]/30 mb-4 font-bold">Markdown Instructions</h2>
                    <ul class="text-[11px] text-[#403F3C]/50 space-y-4 leading-relaxed">
                        <li><span class="font-bold text-[#403F3C]/70 block mb-0.5"># Headers</span> Use for the article title.</li>
                        <li><span class="font-bold text-[#403F3C]/70 block mb-0.5">**Emphasis**</span> For highlighting key findings.</li>
                        <li><span class="font-bold text-[#403F3C]/70 block mb-0.5">> Insights</span> Use for CEO or Builder quotes.</li>
                        <li><span class="font-bold text-[#403F3C]/70 block mb-0.5">![Description](url)</span> For standard images.</li>
                    </ul>
                </section>
            </div>
        </div>
	</div>

    <!-- Component Config Modal -->
    <div id="modal" class="fixed inset-0 bg-[#F8F6F3]/95 backdrop-blur-md z-[200] hidden items-center justify-center p-6 font-yellix">
        <div class="bg-white border border-[#403F3C]/10 p-10 rounded-[32px] max-w-[480px] w-full shadow-2xl">
            <h2 id="modal-title" class="text-sm font-bold uppercase tracking-widest text-[#403F3C] mb-8">Component Settings</h2>
            <div id="modal-fields" class="space-y-6 mb-10"></div>
            <div class="flex gap-4">
                <button id="modal-save" class="flex-1 bg-[#403F3C] text-white text-[10px] font-bold uppercase py-4 rounded-[100px]">Insert Component</button>
                <button id="modal-cancel" class="flex-1 border border-[#403F3C]/10 text-[#403F3C]/40 text-[10px] font-bold uppercase py-4 rounded-[100px]">Cancel</button>
            </div>
        </div>
    </div>

	<script>
		// --- Logic Layer ---
		const editor = document.getElementById('editor') as HTMLTextAreaElement;
        const memoSelect = document.getElementById('memo-select') as HTMLSelectElement;
        const modal = document.getElementById('modal');
        const modalFields = document.getElementById('modal-fields');
        const modalTitle = document.getElementById('modal-title');
        const aiBtn = document.getElementById('ai-btn') as HTMLButtonElement;
        const apiKeyInput = document.getElementById('api-key') as HTMLInputElement;
        const loginBtn = document.getElementById('login-btn');
        const passInput = document.getElementById('password') as HTMLInputElement;

        let activeComponent = '';

        // Session recovery
        if (localStorage.getItem('builder_status') === 'authorized') {
            document.getElementById('auth-view')?.classList.add('hidden');
            document.getElementById('console-view')?.classList.remove('hidden');
            loadMemos();
        }

        async function loadMemos() {
            const res = await fetch('/api/publish');
            const files = await res.json();
            if (Array.isArray(files)) {
                memoSelect.innerHTML = '<option value="">Select Builders Memo...</option>' + 
                files.map(f => `<option value="${f}">${f}</option>`).join('');
            }
        }

        loginBtn?.addEventListener('click', () => {
			if (passInput.value === "robot-builders-2026") {
                localStorage.setItem('builder_status', 'authorized');
				window.location.reload();
			} else {
				alert("Unauthorized.");
			}
		});

        apiKeyInput.value = localStorage.getItem('robot_memos_key') || "";
        apiKeyInput.addEventListener('input', () => {
            localStorage.setItem('robot_memos_key', apiKeyInput.value);
        });

        memoSelect?.addEventListener('change', async () => {
            const fileName = memoSelect.value;
            if (!fileName) return;
            editor.value = "Securely fetching raw memo from repository...";
            const res = await fetch('/api/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'load', fileName })
            });
            const data = await res.json();
            if (data.content) editor.value = data.content;
        });

        // --- D&D / Modal logic ---
        document.querySelectorAll('.component-card').forEach(card => {
            card.addEventListener('dragstart', (e: any) => {
                activeComponent = e.currentTarget.dataset.type || '';
            });
        });

        editor.addEventListener('dragover', (e) => e.preventDefault());
        editor.addEventListener('drop', (e) => {
            e.preventDefault();
            openModal(activeComponent);
        });

        function openModal(type: string) {
            if (!modal || !modalFields || !modalTitle) return;
            modal.style.display = 'flex';
            modalFields.innerHTML = '';
            
            const inputClass = "w-full bg-[#403F3C]/5 border-none py-4 px-6 text-[13px] outline-none rounded-[100px] focus:ring-1 focus:ring-[#403F3C]/10 font-medium";

            if (type === 'slider') {
                modalTitle.innerText = 'Slider Configuration';
                modalFields.innerHTML = `
                    <input type="text" placeholder="Before Image URL" class="${inputClass}" id="field-before">
                    <input type="text" placeholder="After Image URL" class="${inputClass}" id="field-after">
                `;
            } else if (type === 'video') {
                modalTitle.innerText = 'Video Configuration';
                modalFields.innerHTML = `<input type="text" placeholder="Video URL (.mp4)" class="${inputClass}" id="field-video">`;
            } else if (type === 'chart') {
                modalTitle.innerText = 'Chart Configuration';
                modalFields.innerHTML = `
                    <select id="chart-type" class="${inputClass} appearance-none"><option value="line">Line</option><option value="bar">Bar</option><option value="pie">Pie</option></select>
                    <input type="text" id="chart-title" placeholder="Title" class="${inputClass}">
                    <div class="grid grid-cols-2 gap-4"><input type="text" id="field-xaxis" placeholder="X-Axis" class="${inputClass}"><input type="text" id="field-yaxis" placeholder="Y-Axis" class="${inputClass}"></div>
                    <textarea id="chart-data" class="w-full bg-[#403F3C]/5 border-none p-6 text-[11px] font-mono outline-none h-32 rounded-[24px]" placeholder='[{"name": "A", "val": 10}]'></textarea>
                `;
            }
        }

        document.getElementById('modal-save')?.addEventListener('click', () => {
            let tag = '';
            if (activeComponent === 'slider') {
                tag = `\n<BeforeAfterSlider client:load beforeImage="${(document.getElementById('field-before') as any).value}" afterImage="${(document.getElementById('field-after') as any).value}" />\n`;
            } else if (activeComponent === 'video') {
                tag = `\n<video src="${(document.getElementById('field-video') as any).value}" autoplay muted loop class="rounded-sm w-full" />\n`;
            } else if (activeComponent === 'chart') {
                tag = `\n<TelemetryChart client:load type="${(document.getElementById('chart-type') as any).value}" title="${(document.getElementById('chart-title') as any).value}" xAxis="${(document.getElementById('field-xaxis') as any).value}" yAxis="${(document.getElementById('field-yaxis') as any).value}" data={${(document.getElementById('chart-data') as any).value}} />\n`;
            }
            editor.value += tag;
            modal!.style.display = 'none';
        });

        document.getElementById('modal-cancel')?.addEventListener('click', () => modal!.style.display = 'none');
        document.getElementById('logout-btn')?.addEventListener('click', () => { localStorage.removeItem('builder_status'); window.location.reload(); });

        aiBtn?.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value;
            if (!apiKey) return alert("Missing OpenRouter Key");
            aiBtn.innerText = "Hanu is thinking..."; aiBtn.disabled = true;
            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        "model": "google/gemini-2.0-flash-001",
                        "messages": [{ "role": "system", "content": "Transform raw engineering notes into pro minimal blog posts for Robot.com. Output MDX ONLY." }, { "role": "user", "content": editor.value }]
                    })
                });
                const data = await response.json();
                if (data.choices) editor.value = data.choices[0].message.content;
            } finally { aiBtn.innerText = "Fine-tune with AI"; aiBtn.disabled = false; }
        });

        // Publish logic triggers local file write for now
        document.getElementById('publish-btn')?.addEventListener('click', async () => {
            const title = prompt("Article Title?");
            const author = prompt("Builder Name?");
            if (!title || !author) return;
            const res = await fetch('/api/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'publish', title, author, content: editor.value })
            });
            const data = await res.json();
            if (data.success) alert(`Memo published successfully as ${data.slug}.mdx`);
        });
	</script>
</Layout>
