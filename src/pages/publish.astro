---
import Layout from '../layouts/Layout.astro';
---

<Layout title="memos console">
    <!-- AUTH VIEW -->
	<div class="max-w-[400px] mx-auto min-h-[50vh] flex flex-col justify-center" id="auth-view">
		<h1 class="text-3xl font-medium tracking-tighter mb-4 text-[#403F3C]">memos console</h1>
        <p class="text-[14px] text-[#403F3C]/40 mb-12 font-medium">engineering publishing intelligence.</p>
		
		<div class="space-y-6">
            <div class="relative">
			    <input type="password" id="password" placeholder="builder password" class="w-full bg-white border border-[#403F3C]/10 rounded-[10px] px-5 py-3.5 text-[14px] text-[#403F3C] outline-none focus:ring-1 focus:ring-[#403F3C]/10 transition-all pr-20" />
                <button type="button" id="toggle-pass" class="absolute right-5 top-1/2 -translate-y-1/2 text-[13px] font-bold text-[#403F3C]/20 hover:text-[#403F3C] transition-colors z-10">show</button>
            </div>
            <div class="flex items-center gap-2 px-1">
                <input type="checkbox" id="remember-me" class="w-4 h-4 accent-[#403F3C]" />
                <label for="remember-me" class="text-[13px] font-medium text-[#403F3C]/40">remember device</label>
            </div>
			<button id="login-btn" class="w-full bg-[#403F3C] text-[#F8F6F3] text-[14px] font-bold py-3.5 rounded-[10px] hover:opacity-90 transition-opacity">access console</button>
		</div>
	</div>

    <!-- MAIN CONSOLE VIEW (COMPACT) -->
	<div id="console-view" class="hidden w-full max-w-[580px] mx-auto space-y-10 pt-4 pb-32">
        <header class="flex justify-between items-baseline w-full border-b border-[#403F3C]/5 pb-6">
            <div class="flex items-baseline gap-4">
                <h1 class="text-lg font-medium tracking-tighter text-[#403F3C]">console</h1>
                <p class="text-[12px] text-[#403F3C]/30 font-bold">status: authorized</p>
            </div>
            <button id="logout-btn" class="text-[13px] text-[#403F3C]/40 hover:text-red-400 transition-colors">logout</button>
        </header>

        <!-- Step 1 & 0 Mini Config -->
        <div class="grid grid-cols-1 gap-4">
            <div class="flex flex-col gap-2">
			    <label class="text-[12px] text-[#403F3C]/30 font-bold ml-1">0. credentials</label>
                <input type="password" id="api-key-input-box" placeholder="openrouter api key" class="w-full bg-white border border-[#403F3C]/10 rounded-[10px] px-5 py-3 text-[14px] outline-none font-mono" />
            </div>
            
            <div class="flex flex-col gap-2">
                <label class="text-[12px] text-[#403F3C]/30 font-bold ml-1">1. source memo</label>
                <select id="memo-select" class="w-full bg-white border border-[#403F3C]/10 rounded-[10px] px-5 py-3 text-[14px] outline-none font-medium cursor-pointer appearance-none">
                    <option value="">select builder memo...</option>
                </select>
            </div>
        </div>

        <!-- Toolkit (Compact Grid) -->
        <section class="bg-[#403F3C]/[0.02] p-6 rounded-[15px] border border-[#403F3C]/5">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-[12px] text-[#403F3C]/30 font-bold">2. interactive tools</h2>
                <p class="text-[11px] text-[#403F3C]/20">drag to editor</p>
            </div>
            <div class="grid grid-cols-3 gap-3" id="toolbox">
                <div draggable="true" class="component-card group p-3 border border-[#403F3C]/5 rounded-[10px] bg-white hover:border-[#403F3C]/20 cursor-grab active:cursor-grabbing transition-all shadow-sm text-center" data-type="slider">
                    <div class="text-[13px] font-medium text-[#403F3C]/60 group-hover:text-[#403F3C]">slider</div>
                </div>
                <div draggable="true" class="component-card group p-3 border border-[#403F3C]/5 rounded-[10px] bg-white hover:border-[#403F3C]/20 cursor-grab active:cursor-grabbing transition-all shadow-sm text-center" data-type="video">
                    <div class="text-[13px] font-medium text-[#403F3C]/60 group-hover:text-[#403F3C]">video</div>
                </div>
                <div draggable="true" class="component-card group p-3 border border-[#403F3C]/5 rounded-[10px] bg-white hover:border-[#403F3C]/20 cursor-grab active:cursor-grabbing transition-all shadow-sm text-center" data-type="chart">
                    <div class="text-[13px] font-medium text-[#403F3C]/60 group-hover:text-[#403F3C]">chart</div>
                </div>
            </div>
        </section>

        <!-- Editor Area -->
        <section class="space-y-4">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-[12px] text-[#403F3C]/30 font-bold">3. editor</h2>
                <button id="ai-btn" class="bg-white border border-[#403F3C]/10 text-[#403F3C] text-[12px] font-bold px-4 py-1.5 rounded-[10px] hover:bg-zinc-50 transition-colors">tune with ai</button>
            </div>
            <textarea id="editor" class="w-full h-[500px] bg-white border border-[#403F3C]/10 rounded-[12px] p-6 text-[14px] text-[#403F3C]/80 font-medium leading-relaxed outline-none focus:ring-1 focus:ring-[#403F3C]/5 transition-all resize-none shadow-sm font-mono" placeholder="loading..."></textarea>
            
            <button id="publish-btn" class="w-full mt-6 bg-[#403F3C] text-[#F8F6F3] text-[14px] font-bold py-4 rounded-[10px] hover:opacity-90 transition-opacity shadow-lg">ship to production</button>
        </section>
	</div>

    <!-- Modal (Compact) -->
    <div id="modal" class="fixed inset-0 bg-[#F8F6F3]/95 backdrop-blur-md z-[200] hidden items-center justify-center p-6">
        <div class="bg-white border border-[#403F3C]/10 p-8 rounded-[15px] max-w-[400px] w-full shadow-2xl">
            <h2 id="modal-title" class="text-[14px] font-bold text-[#403F3C] mb-6">settings</h2>
            <div id="modal-fields" class="space-y-4 mb-8"></div>
            <div class="flex gap-3">
                <button id="modal-save" class="flex-1 bg-[#403F3C] text-white text-[13px] font-bold py-3 rounded-[10px]">insert</button>
                <button id="modal-cancel" class="flex-1 border border-[#403F3C]/10 text-[#403F3C]/40 text-[13px] font-bold py-3 rounded-[10px]">cancel</button>
            </div>
        </div>
    </div>

	<script>
		const editor = document.getElementById('editor') as HTMLTextAreaElement;
        const memoSelect = document.getElementById('memo-select') as HTMLSelectElement;
        const modal = document.getElementById('modal');
        const modalFields = document.getElementById('modal-fields');
        const modalTitle = document.getElementById('modal-title');
        const aiBtn = document.getElementById('ai-btn') as HTMLButtonElement;
        const apiKeyInput = document.getElementById('api-key-input-box') as HTMLInputElement;
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const passInput = document.getElementById('password') as HTMLInputElement;
        const togglePass = document.getElementById('toggle-pass');
        let activeComponent = '';

        if (localStorage.getItem('builder_status') === 'authorized') {
            document.getElementById('auth-view')?.classList.add('hidden');
            document.getElementById('console-view')?.classList.remove('hidden');
            loadMemos();
        }

        async function loadMemos() {
            const res = await fetch('/api/publish');
            const files = await res.json();
            if (Array.isArray(files)) {
                memoSelect.innerHTML = '<option value="">select builder memo...</option>' + 
                files.map(f => `<option value="${f}">${f}</option>`).join('');
            }
        }

        loginBtn?.addEventListener('click', () => {
			if (passInput.value === "robot-builders-2026") {
                localStorage.setItem('builder_status', 'authorized'); window.location.reload();
			} else { alert("unauthorized."); }
		});

        apiKeyInput.value = localStorage.getItem('robot_memos_key') || "";
        apiKeyInput.addEventListener('input', () => { localStorage.setItem('robot_memos_key', apiKeyInput.value); });

        memoSelect?.addEventListener('change', async () => {
            const fileName = memoSelect.value; if (!fileName) return;
            editor.value = "fetching...";
            const res = await fetch('/api/publish', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'load', fileName })});
            const data = await res.json(); if (data.content) editor.value = data.content;
        });

        document.querySelectorAll('.component-card').forEach(card => { card.addEventListener('dragstart', (e: any) => { activeComponent = e.currentTarget.dataset.type || ''; }); });
        editor.addEventListener('dragover', (e) => e.preventDefault());
        editor.addEventListener('drop', (e) => { e.preventDefault(); openModal(activeComponent); });

        function openModal(type: string) {
            if (!modal || !modalFields || !modalTitle) return;
            modal.style.display = 'flex';
            const inputClass = "w-full bg-white border border-[#403F3C]/10 py-3 px-5 text-[14px] outline-none rounded-[10px] font-medium";
            if (type === 'slider') {
                modalTitle.innerText = 'Slider';
                modalFields.innerHTML = `<input type="text" placeholder="Before Image URL" class="${inputClass}" id="field-before"><input type="text" placeholder="After Image URL" class="${inputClass}" id="field-after">`;
            } else if (type === 'video') {
                modalTitle.innerText = 'Video'; modalFields.innerHTML = `<input type="text" placeholder="Video URL" class="${inputClass}" id="field-video">`;
            } else if (type === 'chart') {
                modalTitle.innerText = 'Chart';
                modalFields.innerHTML = `<select id="chart-type" class="${inputClass}"><option value="line">Line</option><option value="bar">Bar</option></select><input type="text" id="chart-title" placeholder="Title" class="${inputClass}"><textarea id="chart-data" class="w-full bg-white border border-[#403F3C]/10 p-5 text-[13px] font-mono outline-none h-32 rounded-[10px]" placeholder='[{"name": "A", "val": 10}]'></textarea>`;
            }
        }

        document.getElementById('modal-save')?.addEventListener('click', () => {
            let tag = '';
            if (activeComponent === 'slider') tag = `\n<BeforeAfterSlider client:load beforeImage="${(document.getElementById('field-before') as any).value}" afterImage="${(document.getElementById('field-after') as any).value}" />\n`;
            else if (activeComponent === 'video') tag = `\n<video src="${(document.getElementById('field-video') as any).value}" autoplay muted loop class="rounded-sm w-full" />\n`;
            else if (activeComponent === 'chart') tag = `\n<TelemetryChart client:load type="${(document.getElementById('chart-type') as any).value}" title="${(document.getElementById('chart-title') as any).value}" data={${(document.getElementById('chart-data') as any).value}} />\n`;
            editor.value += tag; modal!.style.display = 'none';
        });

        document.getElementById('publish-btn')?.addEventListener('click', async () => {
            const title = prompt("title?"); if (!title) return;
            const res = await fetch('/api/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'publish', title, fileName: memoSelect.value, content: editor.value })
            });
            const data = await res.json();
            if (data.success) alert("shipped!");
        });

        document.getElementById('modal-cancel')?.addEventListener('click', () => modal!.style.display = 'none');
        document.getElementById('logout-btn')?.addEventListener('click', () => { localStorage.removeItem('builder_status'); window.location.reload(); });
        togglePass?.addEventListener('click', () => { const pass = document.getElementById('password') as HTMLInputElement; const isPass = pass.type === 'password'; pass.type = isPass ? 'text' : 'password'; togglePass.innerText = isPass ? 'hide' : 'show'; });
	</script>
</Layout>
