---
import Layout from '../layouts/Layout.astro';
---

<Layout title="memos console">
	<div class="max-w-[400px] mx-auto min-h-[60vh] flex flex-col justify-center" id="auth-view">
		<h1 class="text-3xl font-medium tracking-tighter mb-4 text-[#403F3C]">memos console</h1>
        <p class="text-[12px] text-[#403F3C]/40 mb-16 font-medium tracking-[0.1em]">engineering publishing intelligence.</p>
		
		<div class="space-y-8">
            <div class="relative">
			    <input type="password" id="password" placeholder="builder password" class="w-full bg-[#403F3C]/5 border-none rounded-[100px] px-6 py-4 text-[14px] text-[#403F3C] outline-none font-medium focus:ring-1 focus:ring-[#403F3C]/10 transition-all pr-20" />
                <button type="button" id="toggle-pass" class="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-bold text-[#403F3C]/20 hover:text-[#403F3C] transition-colors z-10">show</button>
            </div>
            <div class="flex items-center gap-2 px-2">
                <input type="checkbox" id="remember-me" class="w-3 h-3 accent-[#403F3C]" />
                <label for="remember-me" class="text-[11px] font-medium text-[#403F3C]/40">remember me on this device</label>
            </div>
			<button id="login-btn" class="w-full bg-[#403F3C] text-[#F8F6F3] text-[12px] font-bold py-4 rounded-[100px] hover:opacity-90 transition-opacity">access console</button>
		</div>
	</div>

	<div id="console-view" class="hidden w-full max-w-[580px] mx-auto space-y-16 pt-12 pb-32">
        <header class="flex justify-between items-center mb-12 w-full">
            <div>
                <h1 class="text-xl font-medium tracking-tighter text-[#403F3C]">memos console</h1>
                <p class="text-[10px] text-[#403F3C]/30 font-bold mt-1">status: authorized</p>
            </div>
            <button id="logout-btn" class="text-[10px] font-bold text-[#403F3C]/20 hover:text-[#403F3C] transition-all">logout</button>
        </header>

        <!-- 1. Configuration (Vertical) -->
        <section class="space-y-6">
            <h2 class="text-[10px] text-[#403F3C]/30 font-bold tracking-[0.1em]">0. configuration</h2>
            <input type="password" id="api-key-input-box" placeholder="openrouter api key" class="w-full bg-[#403F3C]/5 border-none rounded-[100px] px-6 py-4 text-[13px] text-[#403F3C] outline-none font-mono" />
            
            <h2 class="text-[10px] text-[#403F3C]/30 font-bold tracking-[0.1em] pt-4">1. source material</h2>
            <select id="memo-select" class="w-full bg-[#403F3C]/5 border-none rounded-[100px] px-6 py-4 text-[13px] text-[#403F3C] outline-none font-medium cursor-pointer appearance-none">
                <option value="">select builders memo...</option>
            </select>
        </section>

        <!-- 2. Toolbox (Now before editor) -->
        <section class="bg-[#403F3C]/[0.02] p-8 rounded-[32px] border border-[#403F3C]/5">
            <h2 class="text-[10px] text-[#403F3C]/30 mb-6 font-bold tracking-[0.1em]">2. interactive toolkit</h2>
            <div class="grid grid-cols-1 gap-3" id="toolbox">
                <div draggable="true" class="component-card group p-5 border border-[#403F3C]/5 rounded-[20px] bg-white hover:border-[#403F3C]/20 cursor-grab active:cursor-grabbing transition-all shadow-sm" data-type="slider">
                    <div class="text-[11px] font-bold text-[#403F3C]/60 group-hover:text-[#403F3C]">before/after slider</div>
                </div>
                <div draggable="true" class="component-card group p-5 border border-[#403F3C]/5 rounded-[20px] bg-white hover:border-[#403F3C]/20 cursor-grab active:cursor-grabbing transition-all shadow-sm" data-type="video">
                    <div class="text-[11px] font-bold text-[#403F3C]/60 group-hover:text-[#403F3C]">autonomous video</div>
                </div>
                <div draggable="true" class="component-card group p-5 border border-[#403F3C]/5 rounded-[20px] bg-white hover:border-[#403F3C]/20 cursor-grab active:cursor-grabbing transition-all shadow-sm" data-type="chart">
                    <div class="text-[11px] font-bold text-[#403F3C]/60 group-hover:text-[#403F3C]">telemetry chart</div>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-[#403F3C]/5">
                <p class="text-[9px] text-[#403F3C]/30 font-bold mb-2">tip: drag components into the editor below</p>
            </div>
        </section>

        <!-- 3. Editor (Full width of narrow container) -->
        <section class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-[10px] text-[#403F3C]/30 font-bold tracking-[0.1em]">3. draft editor (mdx)</h2>
                <button id="ai-btn" class="bg-white border border-[#403F3C]/10 text-[#403F3C] text-[10px] font-bold px-6 py-2 rounded-[100px] hover:bg-zinc-50 transition-colors">fine-tune with ai</button>
            </div>
            <textarea id="editor" class="w-full h-[600px] bg-[#403F3C]/5 border-none rounded-[24px] p-8 text-[14px] text-[#403F3C]/80 font-medium leading-relaxed outline-none focus:bg-[#403F3C]/8 transition-all resize-none shadow-inner border border-transparent focus:border-[#403F3C]/5" placeholder="content will load here..."></textarea>
            
            <button id="publish-btn" class="w-full mt-12 bg-[#403F3C] text-[#F8F6F3] text-[12px] font-bold py-5 rounded-[100px] hover:opacity-90 transition-opacity">ship to production</button>
        </section>
	</div>

    <div id="modal" class="fixed inset-0 bg-[#F8F6F3]/95 backdrop-blur-md z-[200] hidden items-center justify-center p-6">
        <div class="bg-white border border-[#403F3C]/10 p-10 rounded-[32px] max-w-[480px] w-full shadow-2xl">
            <h2 id="modal-title" class="text-sm font-bold tracking-widest text-[#403F3C] mb-8">settings</h2>
            <div id="modal-fields" class="space-y-6 mb-10"></div>
            <div class="flex gap-4">
                <button id="modal-save" class="flex-1 bg-[#403F3C] text-white text-[10px] font-bold py-4 rounded-[100px]">insert</button>
                <button id="modal-cancel" class="flex-1 border border-[#403F3C]/10 text-[#403F3C]/40 text-[10px] font-bold py-4 rounded-[100px]">cancel</button>
            </div>
        </div>
    </div>

	<script>
		const editor = document.getElementById('editor') as HTMLTextAreaElement;
        const memoSelect = document.getElementById('memo-select') as HTMLSelectElement;
        const modal = document.getElementById('modal');
        const modalFields = document.getElementById('modal-fields');
        const modalTitle = document.getElementById('modal-title');
        const aiBtn = document.getElementById('ai-btn') as HTMLButtonElement;
        const apiKeyInput = document.getElementById('api-key-input-box') as HTMLInputElement;
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const passInput = document.getElementById('password') as HTMLInputElement;
        const togglePass = document.getElementById('toggle-pass');
        let activeComponent = '';

        if (localStorage.getItem('builder_status') === 'authorized') {
            document.getElementById('auth-view')?.classList.add('hidden');
            document.getElementById('console-view')?.classList.remove('hidden');
            loadMemos();
        }

        async function loadMemos() {
            const res = await fetch('/api/publish');
            const files = await res.json();
            if (Array.isArray(files)) {
                memoSelect.innerHTML = '<option value="">select builders memo...</option>' + 
                files.map(f => `<option value="${f}">${f}</option>`).join('');
            }
        }

        loginBtn?.addEventListener('click', () => {
			if (passInput.value === "robot-builders-2026") {
                localStorage.setItem('builder_status', 'authorized'); window.location.reload();
			} else { alert("unauthorized."); }
		});

        apiKeyInput.value = localStorage.getItem('robot_memos_key') || "";
        apiKeyInput.addEventListener('input', () => { localStorage.setItem('robot_memos_key', apiKeyInput.value); });

        memoSelect?.addEventListener('change', async () => {
            const fileName = memoSelect.value; if (!fileName) return;
            editor.value = "fetching raw data...";
            const res = await fetch('/api/publish', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'load', fileName })});
            const data = await res.json(); if (data.content) editor.value = data.content;
        });

        document.querySelectorAll('.component-card').forEach(card => { card.addEventListener('dragstart', (e: any) => { activeComponent = e.currentTarget.dataset.type || ''; }); });
        editor.addEventListener('dragover', (e) => e.preventDefault());
        editor.addEventListener('drop', (e) => { e.preventDefault(); openModal(activeComponent); });

        function openModal(type: string) {
            if (!modal || !modalFields || !modalTitle) return;
            modal.style.display = 'flex';
            const inputClass = "w-full bg-[#403F3C]/5 border-none py-4 px-6 text-[13px] outline-none rounded-[100px] font-medium";
            if (type === 'slider') {
                modalTitle.innerText = 'slider settings';
                modalFields.innerHTML = `<input type="text" placeholder="before image url" class="${inputClass}" id="field-before"><input type="text" placeholder="after image url" class="${inputClass}" id="field-after">`;
            } else if (type === 'video') {
                modalTitle.innerText = 'video settings'; modalFields.innerHTML = `<input type="text" placeholder="video url" class="${inputClass}" id="field-video">`;
            } else if (type === 'chart') {
                modalTitle.innerText = 'chart settings';
                modalFields.innerHTML = `<select id="chart-type" class="${inputClass} appearance-none"><option value="line">line</option><option value="bar">bar</option></select><input type="text" id="chart-title" placeholder="title" class="${inputClass}"><textarea id="chart-data" class="w-full bg-[#403F3C]/5 border-none p-6 text-[11px] font-mono outline-none h-32 rounded-[24px]" placeholder='[{"name": "A", "val": 10}]'></textarea>`;
            }
        }

        document.getElementById('modal-save')?.addEventListener('click', () => {
            let tag = '';
            if (activeComponent === 'slider') tag = `\n<BeforeAfterSlider client:load beforeImage="${(document.getElementById('field-before') as any).value}" afterImage="${(document.getElementById('field-after') as any).value}" />\n`;
            else if (activeComponent === 'video') tag = `\n<video src="${(document.getElementById('field-video') as any).value}" autoplay muted loop class="rounded-sm w-full" />\n`;
            else if (activeComponent === 'chart') tag = `\n<TelemetryChart client:load type="${(document.getElementById('chart-type') as any).value}" title="${(document.getElementById('chart-title') as any).value}" data={${(document.getElementById('chart-data') as any).value}} />\n`;
            editor.value += tag; modal!.style.display = 'none';
        });

        document.getElementById('publish-btn')?.addEventListener('click', async () => {
            const title = prompt("article title?"); if (!title) return;
            const res = await fetch('/api/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'publish', title, fileName: memoSelect.value, content: editor.value })
            });
            const data = await res.json();
            if (data.success) alert("article published to github!");
        });

        document.getElementById('modal-cancel')?.addEventListener('click', () => modal!.style.display = 'none');
        document.getElementById('logout-btn')?.addEventListener('click', () => { localStorage.removeItem('builder_status'); window.location.reload(); });
        document.getElementById('toggle-pass')?.addEventListener('click', () => { const pass = document.getElementById('password') as HTMLInputElement; const isPass = pass.type === 'password'; pass.type = isPass ? 'text' : 'password'; togglePass.innerText = isPass ? 'hide' : 'show'; });
	</script>
</Layout>
