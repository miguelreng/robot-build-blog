---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Memos Console">
	<div class="max-w-[580px] mx-auto min-h-[60vh] flex flex-col justify-center" id="auth-view">
		<h1 class="text-3xl font-medium tracking-tighter mb-4 text-[#403F3C]">Memos Console</h1>
        <p class="text-[12px] text-[#403F3C]/40 mb-16 font-medium tracking-[0.1em]">Engineering Publishing Intelligence.</p>
		
		<div class="space-y-8">
            <div class="relative">
			    <input type="password" id="password" placeholder="Builder Password" class="w-full bg-transparent border-b border-[#403F3C]/10 py-3 text-[14px] text-[#403F3C] outline-none font-medium focus:border-[#403F3C]/30 transition-colors pr-20" />
                <button id="toggle-pass" class="absolute right-0 top-1/2 -translate-y-1/2 text-[10px] uppercase font-bold text-[#403F3C]/20 hover:text-[#403F3C] transition-colors">Show</button>
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" id="remember-me" class="w-3 h-3 accent-[#403F3C]" />
                <label for="remember-me" class="text-[11px] font-medium text-[#403F3C]/40">Remember me on this device</label>
            </div>
			<button id="login-btn" class="w-full bg-[#403F3C] text-[#F8F6F3] text-[12px] font-bold uppercase tracking-widest py-4 rounded-sm hover:opacity-90 transition-opacity">Access Console</button>
		</div>
	</div>

	<div id="console-view" class="hidden space-y-20 pt-20">
        <header class="flex justify-between items-baseline mb-12">
            <div>
                <h1 class="text-2xl font-medium tracking-tighter text-[#403F3C]">Memos Console</h1>
                <p class="text-[10px] text-[#403F3C]/30 font-bold uppercase tracking-widest mt-1">Status: Authorized</p>
            </div>
            <button id="logout-btn" class="text-[10px] uppercase font-bold text-[#403F3C]/20 hover:text-[#403F3C] border-b border-transparent hover:border-[#403F3C]/20 pb-0.5 transition-all">Logout</button>
        </header>

        <section>
            <h2 class="text-[10px] uppercase tracking-[0.2em] text-[#403F3C]/30 mb-6 font-bold">0. Engine Config</h2>
            <input type="password" id="api-key" placeholder="Paste OpenRouter API Key" class="w-full bg-transparent border-b border-[#403F3C]/10 py-3 text-[13px] text-[#403F3C] outline-none font-mono focus:border-[#403F3C]/30 transition-colors" />
            <p class="text-[10px] text-[#403F3C]/30 mt-2 italic">Stored locally in your browser only.</p>
        </section>

        <section>
            <h2 class="text-[10px] uppercase tracking-[0.2em] text-[#403F3C]/30 mb-6 font-bold">1. Source Material</h2>
            <select id="memo-select" class="w-full bg-transparent border-b border-[#403F3C]/10 py-3 text-[14px] text-[#403F3C] outline-none font-medium cursor-pointer focus:border-[#403F3C]/30 transition-colors">
                <option value="">Select Builders Memo...</option>
            </select>
        </section>

        <section>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-[10px] uppercase tracking-[0.2em] text-[#403F3C]/30 font-bold">2. Editor (MDX)</h2>
                <button id="ai-btn" class="bg-white border border-[#403F3C]/10 text-[#403F3C] text-[10px] font-bold uppercase tracking-widest px-4 py-2 rounded-sm hover:bg-zinc-50 transition-colors disabled:opacity-30">Fine-tune with AI</button>
            </div>
            <textarea id="editor" class="w-full h-[600px] bg-[#403F3C]/5 border-none rounded-sm p-8 text-[14px] text-[#403F3C]/80 font-medium leading-relaxed outline-none focus:bg-[#403F3C]/10 transition-all resize-none font-mono" placeholder="Original content will load here..."></textarea>
            
            <div class="mt-4 p-4 border border-[#403F3C]/5 rounded-sm">
                <p class="text-[10px] uppercase tracking-widest text-[#403F3C]/30 font-bold mb-3">Interactive Components Cheat-sheet</p>
                <code class="text-[10px] text-[#403F3C]/50 block mb-2">&lt;BeforeAfterSlider client:load beforeImage="..." afterImage="..." /&gt;</code>
                <code class="text-[10px] text-[#403F3C]/50 block">&lt;img src="..." /&gt; or ![Label](/path)</code>
            </div>
        </section>

        <section class="pb-32">
            <button id="publish-btn" class="w-full bg-[#403F3C] text-[#F8F6F3] text-[12px] font-bold uppercase tracking-widest py-4 rounded-sm hover:opacity-90 transition-opacity Shadow-xl">Ship to Production</button>
        </section>
	</div>

	<script>
		const loginBtn = document.getElementById('login-btn');
		const logoutBtn = document.getElementById('logout-btn');
		const authView = document.getElementById('auth-view');
		const consoleView = document.getElementById('console-view');
		const passInput = document.getElementById('password') as HTMLInputElement;
		const togglePass = document.getElementById('toggle-pass');
		const rememberMe = document.getElementById('remember-me') as HTMLInputElement;
        
        const memoSelect = document.getElementById('memo-select') as HTMLSelectElement;
        const editor = document.getElementById('editor') as HTMLTextAreaElement;
        const aiBtn = document.getElementById('ai-btn') as HTMLButtonElement;
        const apiKeyInput = document.getElementById('api-key') as HTMLInputElement;

        const VALID_PASS = "robot-builders-2026";

        // Auth Logic
        if (localStorage.getItem('builder_status') === 'authorized') {
            authView?.classList.add('hidden');
            consoleView?.classList.remove('hidden');
            loadMemos();
        }

        loginBtn?.addEventListener('click', () => {
			if (passInput.value === VALID_PASS) {
                if (rememberMe.checked) localStorage.setItem('builder_status', 'authorized');
				authView?.classList.add('hidden');
				consoleView?.classList.remove('hidden');
                loadMemos();
			} else {
				alert("Invalid session credentials.");
			}
		});

        logoutBtn?.addEventListener('click', () => {
            localStorage.removeItem('builder_status');
            window.location.reload();
        });

        togglePass?.addEventListener('click', () => {
            const isPass = passInput.type === 'password';
            passInput.type = isPass ? 'text' : 'password';
            togglePass.innerText = isPass ? 'Hide' : 'Show';
        });

        // Config & Content Logic
        apiKeyInput.value = localStorage.getItem('robot_memos_key') || "";
        apiKeyInput?.addEventListener('input', () => {
            localStorage.setItem('robot_memos_key', apiKeyInput.value);
        });

        async function loadMemos() {
            const res = await fetch('/api/publish');
            const files = await res.json();
            if (Array.isArray(files)) {
                memoSelect.innerHTML = '<option value="">Select Builders Memo...</option>' + 
                files.map(f => `<option value="${f}">${f}</option>`).join('');
            }
        }

        memoSelect?.addEventListener('change', async () => {
            const fileName = memoSelect.value;
            if (!fileName) return;
            editor.value = "Establishing secure connection to repository...";
            const res = await fetch('/api/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileName })
            });
            const data = await res.json();
            if (data.content) editor.value = data.content;
        });

        aiBtn?.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value;
            if (!apiKey) return alert("API Key required");
            const originalText = editor.value;
            aiBtn.disabled = true;
            aiBtn.innerText = "Transforming...";
            
            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        "model": "google/gemini-2.0-flash-001",
                        "messages": [
                            { "role": "system", "content": "Professional engineering blog transformer. Output MDX." },
                            { "role": "user", "content": originalText }
                        ]
                    })
                });
                const data = await response.json();
                if (data.choices) editor.value = data.choices[0].message.content;
            } catch (e) {
                alert("AI transformation failed.");
            } finally {
                aiBtn.disabled = false;
                aiBtn.innerText = "Fine-tune with AI";
            }
        });
	</script>
</Layout>
